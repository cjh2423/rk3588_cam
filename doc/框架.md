# RK3588 异步 AI 视频处理框架 (C++17 + Qt5 + OpenCV)

本项目是一个专门为 RK3588 平台设计的、解耦型多线程视频处理框架。它采用标准 C++17 线程处理密集型计算，利用 Qt 负责 UI 渲染，并深度集成了 RK3588 的硬件加速能力 (RGA/NPU)。

## 1. 核心架构图

### 线程模型

#### 主线程 (Qt UI Thread):
- **职责**：负责 QApplication 事件循环、界面刷新。
- **输入**：通过信号槽机制 (`updateFrame`) 接收已转换好的 `QImage`。
- **特点**：零计算负担。不进行 resize, color convert 或任何推理操作。

#### 预处理线程 (Preprocessing Thread):
- **职责**：摄像头采集、图像预处理。
- **硬件加速**：
    - **V4L2**：硬件零拷贝采集 (部分实现)。
    - **RGA**：使用 `librga` 进行硬件加速的 **镜像翻转 (Flip)** 和 **缩放 (Resize)**。
- **流程**：
    1.  从 `CameraDevice` 读取原始帧 (`cv::Mat` wrapping buffer).
    2.  调用 RGA 进行 Flip + Resize (Letterbox 填充).
    3.  将处理后的数据 (UI显示用的图 + 模型输入用的图) 打包为 `PreprocessTask`.
    4.  推入线程安全队列。

#### (规划中) NPU 推理线程:
- **职责**：从队列获取任务，执行 RKNN 推理。
- **组件**：
    - **ModelManager**：管理 YOLOv8-face 和 FaceNet 模型的加载与释放。
    - **Core Logic**：执行检测与识别算法。

## 2. 目录结构说明 (实际工程)

```text
├── gui/
│   ├── include/cameraview.h       # 界面类：显示图像，显示统计信息
│   └── src/cameraview.cpp         # 界面实现
├── include/
│   ├── app/
│   │   ├── app_controller.h       # 总控制器：管理线程与 UI 的交互
│   │   ├── preprocessing_thread.h # 预处理线程：集成 RGA
│   │   └── performance_monitor.h  # 性能监控
│   ├── core/
│   │   ├── model_manager.h        # 模型管理 (YOLO/FaceNet)
│   │   ├── yolov8_face.h          # YOLOv8-face 算法实现
│   │   └── facenet.h              # FaceNet 算法实现
│   └── hardware/
│       └── camera_device.h        # V4L2 摄像头封装
├── src/
│   ├── app/
│   │   ├── app_controller.cc      # 胶水逻辑：连接 UI、Monitor 和 Thread
│   │   └── preprocessing_thread.cc# RGA 硬件加速实现核心
│   ├── core/                      # 算法实现
│   └── main.cc                    # 程序入口
├── 3rdparty/                      # RGA, RKNN 库
└── build.sh                       # 交叉编译脚本
```

## 3. 关键流程详解

### A. 启动流程 (`AppController::start`)
1.  根据 `PROJECT_MODE` (在 `config.h`) 决定启动模式。
2.  **Mode 1 (AI Mode)**:
    *   启动 `PreprocessingThread`。
    *   线程内部打开摄像头 (`CameraDevice`)。
    *   启动 `PerformanceMonitor`。
    *   启动 UI 刷新定时器 (`QTimer`).

### B. 帧处理流程 (`PreprocessingThread::thread_func`)
1.  **Capture**: `m_camera.read(frame)`。
2.  **RGA Process**:
    *   `imflip`: 硬件水平翻转。
    *   `improcess`: 硬件缩放 (Resize) 到模型输入尺寸 (如 640x640)，自动进行 Letterbox 补黑边。
3.  **Push**: 将 `PreprocessTask` (含原图 clone 和处理后的图) 推入 `output_queue_`。

### C. 渲染流程 (`AppController::onFrameTick`)
1.  定时器触发，检查队列是否有新任务。
2.  取出任务。
3.  **Zero-Copy Display**:
    *   构造 `QImage` 指向 RGA 处理后的内存 (注意步长 step)。
    *   调用 `m_view->updateFrame`。
4.  (TODO) 将任务转发给 NPU 线程进行推理。

## 4. 硬件加速细节

- **RGA (Rockchip Graphics Acceleration)**:
    - 用于替代 OpenCV 的 `cv::resize` 和 `cv::flip`。
    - 显著降低 CPU 占用率，为 NPU 推理留出 CPU 时间进行后处理。
    - 代码位置：`src/app/preprocessing_thread.cc` -> `process_with_rga`.

- **NPU (Neural Processing Unit)**:
    - 使用 RKNN API (`librknnrt`).
    - 模型管理器：`src/core/model_manager.cc`.
    - 支持 INT8 量化模型 (YOLOv8) 和 FP16/INT8 (FaceNet).
